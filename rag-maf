#!/bin/bash
# RAG-MAF CLI wrapper
PLUGIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Check if virtual environment exists
if [ ! -d "$PLUGIN_DIR/venv" ]; then
    echo "Error: Virtual environment not found at $PLUGIN_DIR/venv"
    echo "Please run ./install.sh first"
    exit 1
fi

# Activate virtual environment
source "$PLUGIN_DIR/venv/bin/activate"

case "$1" in
    start)
        echo "Starting MCP server..."
        cd "$PLUGIN_DIR"
        # Use module execution to fix relative imports
        PYTHONPATH="$PLUGIN_DIR/src" python3 -m src.mcp_server.server &
        SERVER_PID=$!
        echo $SERVER_PID > "$PLUGIN_DIR/.mcp_server.pid"
        echo "MCP server started (PID: $SERVER_PID)"
        echo "Server running on http://127.0.0.1:8765"
        ;;
    stop)
        echo "Stopping MCP server..."
        if [ -f "$PLUGIN_DIR/.mcp_server.pid" ]; then
            PID=$(cat "$PLUGIN_DIR/.mcp_server.pid")
            kill $PID 2>/dev/null && echo "MCP server stopped (PID: $PID)" || echo "Process not found"
            rm "$PLUGIN_DIR/.mcp_server.pid"
        else
            # Fallback: kill by process name
            pkill -f "src.mcp_server.server" && echo "MCP server stopped" || echo "No MCP server process found"
        fi
        ;;
    status)
        if [ -f "$PLUGIN_DIR/.mcp_server.pid" ]; then
            PID=$(cat "$PLUGIN_DIR/.mcp_server.pid")
            if ps -p $PID > /dev/null 2>&1; then
                echo "MCP server is running (PID: $PID)"
                echo "Server URL: http://127.0.0.1:8765"
                exit 0
            else
                echo "MCP server is not running (stale PID file)"
                rm "$PLUGIN_DIR/.mcp_server.pid"
                exit 1
            fi
        else
            if pgrep -f "src.mcp_server.server" > /dev/null; then
                echo "MCP server is running (no PID file)"
                exit 0
            else
                echo "MCP server is not running"
                exit 1
            fi
        fi
        ;;
    index)
        echo "Indexing codebase..."
        cd "$PLUGIN_DIR"
        python3 << 'PYSCRIPT'
import sys
sys.path.insert(0, 'src')
from rag.query_engine import QueryEngine
engine = QueryEngine()
engine.index_codebase('.')
print('Indexing complete!')
PYSCRIPT
        ;;
    test)
        echo "Testing RAG system..."
        cd "$PLUGIN_DIR"
        python3 << 'PYSCRIPT'
import sys
sys.path.insert(0, 'src')
from rag.query_engine import QueryEngine
engine = QueryEngine()
print('RAG system initialized successfully!')
print(f'Vector store location: {engine.vector_store.persist_directory}')
PYSCRIPT
        ;;
    logs)
        echo "Showing MCP server logs..."
        if [ -f "$PLUGIN_DIR/logs/mcp_server.log" ]; then
            tail -f "$PLUGIN_DIR/logs/mcp_server.log"
        else
            echo "No log file found at $PLUGIN_DIR/logs/mcp_server.log"
        fi
        ;;
    restart)
        echo "Restarting MCP server..."
        $0 stop
        sleep 2
        $0 start
        ;;
    *)
        echo "RAG-MAF Plugin Control Script"
        echo ""
        echo "Usage: $0 {start|stop|status|restart|index|test|logs}"
        echo ""
        echo "Commands:"
        echo "  start    - Start the MCP server"
        echo "  stop     - Stop the MCP server"
        echo "  status   - Check if MCP server is running"
        echo "  restart  - Restart the MCP server"
        echo "  index    - Index the current codebase"
        echo "  test     - Test RAG system initialization"
        echo "  logs     - Show MCP server logs"
        echo ""
        exit 1
        ;;
esac
